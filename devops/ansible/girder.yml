---
- name: Intial Setup
  hosts: all
  gather_facts: false
  tasks:
    - name: Install Python
      raw: test -e /usr/bin/python || (apt-get update && apt-get install -y python python-pip)

- name: Install Girder
  hosts: all
  pre_tasks:
    - name: Install sudo
      apt:
        name:
          - sudo

    - name: Create root directory
      file:
        path: "{{ root_dir }}"
        state: directory
        mode: 0755

  roles:

    - role: girder.girder
      girder_version: "2.x-maintenance"
      girder_daemonize: false
      # We build the girder web assets in girder-histomicstk
      girder_web: no
      become: true
      become_user: "{{ girder_exec_user }}"


- name: Install Mapnik dependencies
  hosts: memcached
  tasks:
    - name: Install memcached
      apt:
        name: memcached

- name: Install Mapnik dependencies
  hosts: mapnik
  tasks:
    - name: Install system packages
      apt:
        name:
          - libgdal-dev
          - gdal-bin
          - libmapnik-dev
          - python-mapnik

    - name: Install GDAL 1 python package
      pip:
        name: gdal==1.10.0
        chdir: "{{ large_image_path }}"

  environment:
    CPLUS_INCLUDE_PATH: /usr/include/gdal
    C_INCLUDE_PATH: /usr/include/gdal


- name: Install Openslide dependencies
  hosts: openslide
  pre_tasks:
    - name: Remove Stock libtiff
      apt:
        name: libtiff5-dev
        state: absent

    - name: Remove Stock libtiff
      apt:
        autoremove: yes
  roles:
    - role: DigitalSlideArchive.vips


- name: Install Large Image
  hosts: all
  pre_tasks:
    - name: Install libtiff
      apt:
        name: libtiff5-dev

  roles:
    - role: large_image
      # Note: Take the groups this host is in, do a set intersection
      # with the list of valid extras_require and join them as a comma
      # seperated list.
      large_image_extras_require: "[{{ group_names | intersect(['memcached', 'openslide', 'mapnik' ]) | join(',') }}]"
    - role: npm

  post_tasks:
    - name: Rebuild Girder web
      command: "girder-install web --dev --plugins large_image,worker,jobs"
